---
title: "EpiSim vs tPath speed"
author: "skyebend"
date: "October, 2015"
output: html_document
---

# Compare speeds of evaluating components with EpiSim vs tPath

The EpiModel code comes almost completely from Sam Jenness' workbook Modeling Epidemics over Observed Networks  http://statnet.github.io/gal/empnet.html

```{r}
library(tsna)
library(EpiModel)
library(networkDynamicData)
library(microbenchmark)

```

load example data object and remove existing infection attribute
```{r}
data(concurrencyComparisonNets)
nw <- base
nw <- delete.vertex.attribute(nw, "status.active")
```   

Define an init module for EpiModel that will use the observed example network instead of generating one from a sim

```{r}
net.init.mod <- function(x, param, init, control, s) {

  # Master Data List
  dat <- list()
  dat$param <- param
  dat$init <- init
  dat$control <- control

  dat$attr <- list()
  dat$stats <- list()
  dat$temp <- list()

  # Network Parameters
  dat$nw <- x
  dat$param$modes <- 1

  # Initialization

  ## Infection Status and Time Modules
  n <- network.size(dat$nw)
  dat$attr$status <- rep("s", n)
  dat$attr$status[sample(1:n, init$i.num)] <- "i"
  
  dat$attr$active <- rep(1, n)
  dat$attr$entrTime <- rep(1, n)
  dat$attr$exitTime <- rep(NA, n)
  
  dat$attr$infTime <- rep(NA, n)
  dat$attr$infTime[dat$attr$status == "i"] <- 1

  ## Get initial prevalence
  dat <- get_prev.net(dat, at = 1)

  return(dat)
}
```

Similarly, define an infection module

```{r}
my.inf.mod <- function(dat, at) {

    ## Variables ##
    active <- dat$attr$active
    status <- dat$attr$status

    inf.prob <- dat$param$inf.prob
    act.rate <- dat$param$act.rate

    nw <- dat$nw

    # Vector of infected and susceptible IDs
    idsSus <- which(active == 1 & status == "s")
    idsInf <- which(active == 1 & status == "i")
    nActive <- sum(active == 1)
    nElig <- length(idsInf)

    # Initialize vectors
    nInf <- totInf <- 0

    ## Processes ##
    # If some infected AND some susceptible, then proceed
    if (nElig > 0 && nElig < nActive) {

      # Get discordant edgelist
      del <- discord_edgelist(dat, idsInf, idsSus, at)

      # If some discordant edges, then proceed
      if (!(is.null(del))) {

        # Infection probabilities
        del$transProb <- inf.prob

        # Act rates
        del$actRate <- act.rate

        # Calculate final transmission probability per timestep
        del$finalProb <- 1 - (1 - del$transProb) ^ del$actRate

        # Randomize transmissions and subset df
        transmit <- rbinom(nrow(del), 1, del$finalProb)
        del <- del[which(transmit == 1), ]

        # Set new infections vector
        idsNewInf <- unique(del$sus)
        totInf <- length(idsNewInf)

        # Update attributes
        if (totInf > 0) {
          dat$attr$status[idsNewInf] <- "i"
          dat$attr$infTime[idsNewInf] <- at
        }

      } 
    } 

   ## Summary statistics ##
   if (at == 2) {
     dat$epi$si.flow <- c(0, totInf)
   } else {
     dat$epi$si.flow[at] <- totInf
   }

   dat$nw <- nw
   return(dat)
}
```

Set up sim params

```{r}
param <- param.net(inf.prob = 1.0)
init <- init.net(i.num = 10)
control <- control.net(type = "SI", nsteps = 100, nsims = 1,
                       initialize.FUN = net.init.mod, infection.FUN = my.inf.mod,
                       verbose.FUN = NULL,
                       module.order = c("infection.FUN", "get_prev.FUN"),
                       skip.check = TRUE, save.nwstats = FALSE, save.network = FALSE)
```

Run the epi disease sim

```{r}
sim <- netsim(nw, param, init, control)
```

compare the timing of a bunch of runs of infection process in EpiModel vs. tpath
```{r}
timing<-microbenchmark(episim=netsim(nw,param,init,control),fwdpath=tPath(nw,v=sample(1:network.size(nw),1)),unit = 's')
timing
plot(timing)
```

So on average (for the base network) episim takes about more than 4 times as long, but the slowest cases ares about 3x slower, and the fastest cases are 60x slower than fwdpath. 


